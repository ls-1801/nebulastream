name: Code Coverage
description: |
  This workflow is triggered by the pr.yml workflow.
  We are using this workflow to build the code coverage for the PR branches.
  To get the code coverage, we use codecov which operates on lcov files generated by building with the flag CODE_COVERAGE=ON and running the tests.
  The test have a timeout of 90 minutes, as building the code coverage can take a long time.
on:
  # We are using this yaml in other workflows, e.g., nightly or PR, so we need to allow another workflow call to trigger this workflow.
  # We are expecting the tag of the docker image to be passed as an output from the previous job.
  workflow_call:
    inputs:
      dev_image_tag:
        required: true
        type: string
        description: "Docker image tag of the development image of the head commit"
      head_sha:
        required: true
        type: string
        description: "Commit sha of head"
      branch-name:
        required: false
        type: string
        description: name of the branch the coverage will be associated with, if not provided codecov will pick

jobs:
  build-code-coverage-pr-branch:
    timeout-minutes: 90
    runs-on: ${{ matrix.runner }}
    env:
      SCCACHE_BUCKET: ${{ secrets.VCPKG_BINARY_S3_BUCKET }}
      SCCACHE_ENDPOINT: ${{ secrets.VCPKG_BINARY_S3_ENDPOINT }}
      SCCACHE_REGION: auto
      SCCACHE_S3_USE_SSL: true
      SCCACHE_S3_KEY_PREFIX: sccache
      AWS_ACCESS_KEY_ID: ${{ secrets.VCPKG_BINARY_S3_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.VCPKG_BINARY_S3_SECRET }}
    strategy:
      fail-fast: false
      matrix:
        platform: [ x64 ]
        include:
          - platform: x64
            runner: [ "ubuntu-24.04" ]
    steps:
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.head_sha }}
      - uses: ./.github/steps/prepare-github
        with:
          image_name: nebulastream/nes-ci:${{ inputs.dev_image_tag }}
      - uses: ./.github/steps/run-in-container
        name: Build coverage and export as lcov
        with:
          image_name: nebulastream/nes-ci:${{ inputs.dev_image_tag }}
          run: |
            export SCCACHE_IDLE_TIMEOUT=0
            sccache --start-server
            cmake -DCODE_COVERAGE=ON -B build
            cmake --build build -j -- -k 0
            cmake --build build --target ccov-all-export
            echo "=== sccache Statistics ==="
            sccache --show-stats || echo "sccache stats not available"
      - uses: codecov/codecov-action@v5
        with:
          slug: nebulastream/nebulastream
          fail_ci_if_error: false
          files: build/ccov/coverage.lcov
          token: ${{ secrets.CODECOV_TOKEN }}
          override_branch: ${{ inputs.branch-name }}
          override_commit: ${{ inputs.head_sha }}
          report_type: coverage
