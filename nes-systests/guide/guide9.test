# name: window/aggregation/TumblingApiRequestStats.test
# description: Count and average response time per endpoint in tumbling windows
# groups: [Window, Aggregation, Tumbling, Count, Avg]

CREATE LOGICAL SOURCE api_requests(
    endpoint VARSIZED,
    response_time FLOAT64,
    ts INT64
);
CREATE PHYSICAL SOURCE FOR api_requests TYPE File;
ATTACH INLINE
/login,120.0,10
/login,100.0,20
/search,200.0,30
/login,80.0,40
/search,220.0,50
/login,90.0,310
/search,210.0,320
/search,190.0,330

# Aggregates:
# COUNT(response_time) -> API_REQUESTS$RESPONSE_TIME_COUNT
# AVG(response_time)   -> API_REQUESTS$RESPONSE_TIME_AVG
CREATE SINK sink(
    `API_REQUESTS$RESPONSE_TIME_COUNT` INT64,
    `API_REQUESTS$RESPONSE_TIME_AVG`   FLOAT64
) TYPE File;

SELECT
    COUNT(response_time),
    AVG(response_time)
FROM api_requests
GROUP BY endpoint
WINDOW TUMBLING(ts, SIZE 5 MIN)
INTO sink;
----
3,100.0
2,210.0
1,90.0
2,200.0
